#!/usr/bin/env bash

if [[ ! $AIRFLOW__DATABASE__SQL_ALCHEMY_CONN ]]
then
  echo "missing env variableâ€¦"
  exit 1
fi

# initialize the database
airflow db migrate
# create an admin user
airflow users create \
    --username $AIRFLOW_USERNAME \
    --firstname $AIRFLOW_FIRSTNAME \
    --lastname $AIRFLOW_LASTNAME \
    --role Admin \
    --email $AIRFLOW_EMAIL \
    --password $AIRFLOW_PASSWORD

# ln -s `pwd`/dags $AIRFLOW_HOME/dags

airflow scheduler &

# start the web server, default port is 8080
echo "Starting the webserver..."
port=${PORT:-80}
airflow webserver --port $port --debug
