# Use the Bitnami Airflow image
FROM bitnami/airflow:latest

COPY entrypoint.sh /entrypoint.sh

USER root
RUN chmod +x /entrypoint.sh
USER 1001

# Set ARG for build-time variables
ARG AIRFLOW_DATABASE_PASSWORD
ARG AIRFLOW_DATABASE_USERNAME
ARG AIRFLOW_EMAIL
ARG AIRFLOW_EXECUTOR
ARG AIRFLOW__CELERY__BROKER_URL
ARG AIRFLOW__DATABASE__SQL_ALCHEMY_CONN

ENV AIRFLOW_DATABASE_PASSWORD=${AIRFLOW_DATABASE_PASSWORD} \
    AIRFLOW_DATABASE_USERNAME=${AIRFLOW_DATABASE_USERNAME} \
    AIRFLOW_EMAIL=${AIRFLOW_EMAIL} \
    AIRFLOW_EXECUTOR=${AIRFLOW_EXECUTOR} \
    AIRFLOW__CELERY__BROKER_URL=${AIRFLOW__CELERY__BROKER_URL} \
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW__DATABASE__SQL_ALCHEMY_CONN}  \
    AIRFLOW_DATABASE_NAME=bitnami_airflow \
    AIRFLOW_DATABASE_USERNAME=bn_airflow \
    AIRFLOW__WEBSERVER__PORT=8080

EXPOSE 8080

RUN airflow db init


# Use the custom entrypoint script
CMD ["airflow", "standalone","--port","8080"]
